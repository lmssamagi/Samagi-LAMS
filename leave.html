<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Request | Samagi Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f5f5f5;
      margin: 0;
    }
    .form-card {
      max-width: 600px;
      margin: 1.5rem auto;
      border-radius: 1.25rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-primary bg-gradient mb-3">
    <div class="container-fluid">
      <button class="btn btn-link text-white text-decoration-none" onclick="location.href='index.html'">
        ← Home
      </button>
      <span class="navbar-brand mb-0 h6 text-white">
        Leave Request
      </span>
      <span></span>
    </div>
  </nav>

  <div class="container px-3">
    <div class="card form-card">
      <div class="card-body p-4">
        <h5 class="card-title mb-3">Leave Request Form</h5>
        <p class="text-muted small mb-3">
          Fill in the details below and submit your leave request for approval.
        </p>

        <form id="leaveForm" class="needs-validation" novalidate>
          <div class="mb-3">
            <label class="form-label">Employee Code</label>
            <input type="text" id="employeeCode" class="form-control" required />
            <div class="invalid-feedback">Employee code is required.</div>
          </div>

          <!-- Employee name + balances combined (two rows) -->
          <div class="mb-3">
            <label class="form-label">Employee &amp; Leave Balances</label>
            <div id="balanceInfo" class="small text-muted">
              <strong>-</strong><br>
              Annual: - | Casual: - | Weekend: - | Short (this month): -
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Leave Type</label>
            <select id="leaveType" class="form-select" required>
              <option value="">Select type</option>
              <option value="Annual Leave">Annual Leave</option>
              <option value="Casual Leave">Casual Leave</option>
              <option value="Special Sick Leave">Special Sick Leave</option>
              <option value="Short Leave">Short Leave</option>
              <option value="Weekend Leave">Weekend Leave</option>
              <option value="Maternity Leave">Maternity Leave</option>
              <option value="Paternity Leave">Paternity Leave</option>
              <option value="NoPay Leave">NoPay Leave</option>
            </select>
            <div class="invalid-feedback">Please select a leave type.</div>
          </div>

          <div class="row">
            <div class="col-12 col-md-6 mb-3">
              <label class="form-label">Leave From</label>
              <input type="date" id="leaveFrom" class="form-control" required />
              <div class="invalid-feedback">Please select start date.</div>
            </div>
            <div class="col-12 col-md-6 mb-3">
              <label class="form-label">Leave To</label>
              <input type="date" id="leaveTo" class="form-control" required />
              <div class="invalid-feedback">Please select end date.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Number of Days</label>
            <input
              type="number"
              id="numDays"
              class="form-control"
              min="0.5"
              step="0.5"
              required
              readonly
            />
            <div class="invalid-feedback">Number of days is required.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Reason (optional)</label>
            <textarea id="reason" class="form-control" rows="3"></textarea>
          </div>

          <div class="d-grid">
            <button type="submit" id="submitBtn" class="btn btn-primary">
              Submit Leave Request
            </button>
          </div>

          <div id="statusMsg" class="mt-3 small"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbwckp7p4NPM4U15oNzVOsl2u4sSM6oLiDSsFHonjldMv4nBnPBggvQD4uQXZiX4-Xl73Q/exec";

    const leaveForm   = document.getElementById("leaveForm");
    const statusMsg   = document.getElementById("statusMsg");
    const submitBtn   = document.getElementById("submitBtn");
    const codeInput   = document.getElementById("employeeCode");
    const leaveTypeEl = document.getElementById("leaveType");
    const leaveFromEl = document.getElementById("leaveFrom");
    const leaveToEl   = document.getElementById("leaveTo");
    const numDaysEl   = document.getElementById("numDays");
    const balanceInfo = document.getElementById("balanceInfo");

    let currentEmployee = null;

    function setStatus(msg, isError = false) {
      statusMsg.textContent = msg || "";
      statusMsg.className = "mt-3 small " + (isError ? "text-danger" : "text-muted");
    }

    function clearBalances() {
      balanceInfo.innerHTML =
        "<strong>-</strong><br>" +
        "Annual: - | Casual: - | Weekend: - | Short (this month): -";
    }

    async function fetchEmployee() {
      const code = codeInput.value.trim();
      currentEmployee = null;
      clearBalances();

      if (!code) {
        setStatus("");
        return;
      }

      try {
        setStatus("Looking up employee...");
        const res = await fetch(
          SCRIPT_URL + "?action=getEmployee&code=" + encodeURIComponent(code)
        );
        const data = await res.json();
        if (!data.success) {
          setStatus("❌ " + (data.error || "Employee not found"), true);
          return;
        }
        currentEmployee = data.employee;

        const name       = currentEmployee.name || "-";
        const annualBal  = currentEmployee.annualBalance || 0;
        const casualBal  = currentEmployee.casualBalance || 0;
        const weekendBal = currentEmployee.weekendBalance || 0;
        const shortBal   = currentEmployee.shortBalance || 0;

        balanceInfo.innerHTML =
          "<strong>" + name + "</strong><br>" +
          "Annual: " + annualBal +
          " | Casual: " + casualBal +
          " | Weekend: " + weekendBal +
          " | Short (this month): " + shortBal;

        setStatus(""); // clear bottom status
      } catch (err) {
        console.error(err);
        setStatus("❌ Error looking up employee.", true);
      }
    }

    codeInput.addEventListener("blur", fetchEmployee);

    function calculateDays() {
      const from = leaveFromEl.value;
      const to   = leaveToEl.value;
      if (!from || !to) {
        numDaysEl.value = "";
        return;
      }
      const start = new Date(from);
      const end   = new Date(to);
      const diffMs = end - start;
      const days = diffMs / (1000 * 60 * 60 * 24) + 1;
      if (days > 0) {
        numDaysEl.value = days.toFixed(1).replace(/\.0$/, "");
      } else {
        numDaysEl.value = "";
      }
    }

    leaveFromEl.addEventListener("change", calculateDays);
    leaveToEl.addEventListener("change", calculateDays);

    function validateBusinessRules(payload) {
      const errors = [];
      if (!currentEmployee) {
        errors.push("Invalid Employee Code or employee not loaded.");
      }

      const leaveType = payload.leaveType;
      const numDays   = parseFloat(payload.numDays || "0");

      if (!leaveType) {
        errors.push("Leave Type is required.");
      }
      if (!payload.leaveFrom || !payload.leaveTo || !payload.numDays) {
        errors.push("Leave From, Leave To and Number of Days are required.");
      }

      if (!currentEmployee) {
        return errors;
      }

      const serviceYear    = String(currentEmployee.serviceYear || "");
      const annualBal      = parseFloat(currentEmployee.annualBalance || "0");
      const casualBal      = parseFloat(currentEmployee.casualBalance || "0");
      const weekendBal     = parseFloat(currentEmployee.weekendBalance || "0");
      const shortBal       = parseFloat(currentEmployee.shortBalance || "0");
      const joinDateStr    = currentEmployee.joinDate;

      // Short Leave rules
      if (leaveType === "Short Leave") {
        if (numDays !== 1) {
          errors.push("Short Leave can only be applied for 1 day.");
        }
        if (shortBal <= 0) {
          errors.push("No Short Leave balance remaining for this month.");
        }
      }

      // Annual Leave rules
      if (leaveType === "Annual Leave") {
        if (serviceYear === "Year 1") {
          errors.push("Annual Leave is not available for Year 1 employees.");
        }
        if (numDays > annualBal) {
          errors.push("Requested days exceed Annual Leave balance.");
        }
      }

      // Casual Leave rules
      if (leaveType === "Casual Leave") {
        if (serviceYear !== "Year 1") {
          errors.push("Casual Leave is only for first-year employees.");
        }
        if (numDays > casualBal) {
          errors.push("Requested days exceed Casual Leave balance.");
        }
      }

      // Special Sick Leave: only if both Annual & Casual balances are 0
      if (leaveType === "Special Sick Leave") {
        if (annualBal > 0 || casualBal > 0) {
          errors.push("Special Sick Leave is only allowed when Annual and Casual balances are 0.");
        }
      }

      // Weekend Leave: use Weekend balance
      if (leaveType === "Weekend Leave") {
        if (numDays > weekendBal) {
          errors.push("Requested days exceed Weekend Leave balance.");
        }
      }

      // Paternity Leave: service > 6 months, max 2 days
      if (leaveType === "Paternity Leave") {
        if (joinDateStr) {
          const joinDate  = new Date(joinDateStr);
          const today     = new Date();
          const months =
            (today.getFullYear() - joinDate.getFullYear()) * 12 +
            (today.getMonth() - joinDate.getMonth());
          if (months < 6) {
            errors.push("Paternity Leave is only available after 6 months of service.");
          }
        }
        if (numDays > 2) {
          errors.push("Paternity Leave cannot exceed 2 days.");
        }
      }

      // NoPay Leave: only when Annual & Casual are 0
      if (leaveType === "NoPay Leave") {
        if (numDays <= 0) {
          errors.push("Invalid number of days for NoPay Leave.");
        }
        if (annualBal > 0 || casualBal > 0) {
          errors.push("NoPay Leave can only be applied when both Annual and Casual leave balances are 0.");
        }
      }

      return errors;
    }

    leaveForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!leaveForm.checkValidity()) {
        leaveForm.classList.add("was-validated");
        return;
      }

      leaveForm.classList.remove("was-validated");
      setStatus("");
      submitBtn.disabled = true;

      calculateDays(); // recalc to be safe

      const payload = {
        type: "leave",
        employeeCode: codeInput.value.trim(),
        employeeName: currentEmployee ? currentEmployee.name : "",
        leaveType: leaveTypeEl.value,
        leaveFrom: leaveFromEl.value,
        leaveTo: leaveToEl.value,
        numDays: numDaysEl.value,
        reason: document.getElementById("reason").value.trim()
      };

      const errors = validateBusinessRules(payload);
      if (errors.length > 0) {
        setStatus("❌ " + errors.join(" "), true);
        submitBtn.disabled = false;
        return;
      }

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        setStatus("✅ Leave request submitted successfully.", false);
        leaveForm.reset();
        currentEmployee = null;
        numDaysEl.value = "";
        clearBalances();
      } catch (err) {
        console.error(err);
        setStatus("❌ Error submitting. Please contact HR.", true);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
